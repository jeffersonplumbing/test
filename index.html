<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sonar App (5-200 ft)</title>
</head>
<body>
  <h1>Sonar Distance Measurement</h1>
  <button onclick="startSonar()">Start Sonar</button>
  <div id="results">Results will appear here...</div>

  <script>
    async function startSonar() {
      // Initialize AudioContext
      const audioContext = new AudioContext({ sampleRate: 44100 });
      const chirpDuration = 0.05; // 50ms chirp
      const chirpInterval = 0.5; // 0.5s between chirps
      const numChirps = 5;
      const recordingDuration = 0.5; // Enough for 200ft echo (~356ms)
      const speedOfSound = 1125; // ft/s
      let recordings = [];

      // Get microphone access
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const micSource = audioContext.createMediaStreamSource(stream);

      // Set up MediaRecorder
      const mediaRecorder = new MediaRecorder(stream);
      let chunks = [];
      mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
      mediaRecorder.onstop = async () => {
        const blob = new Blob(chunks, { type: 'audio/webm' });
        chunks = [];
        const arrayBuffer = await blob.arrayBuffer();
        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
        recordings.push(audioBuffer);
        if (recordings.length === numChirps) {
          analyzeRecordings(recordings);
        }
      };

      // Generate and play chirps
      document.getElementById('results').innerText = 'Recording...';
      for (let i = 0; i < numChirps; i++) {
        const oscillator = audioContext.createOscillator();
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(200 + (i * 100), audioContext.currentTime); // 200Hz to 600Hz
        oscillator.connect(audioContext.destination);
        oscillator.start(audioContext.currentTime + i * chirpInterval);
        oscillator.stop(audioContext.currentTime + i * chirpInterval + chirpDuration);

        // Record each chirp
        mediaRecorder.start();
        await new Promise((resolve) => setTimeout(resolve, recordingDuration * 1000));
        mediaRecorder.stop();
        await new Promise((resolve) => setTimeout(resolve, 100)); // Buffer for stop
      }

      // Analyze recordings
      function analyzeRecordings(buffers) {
        const distances = [];
        buffers.forEach((buffer, i) => {
          const samples = buffer.getChannelData(0);
          const sampleRate = buffer.sampleRate;

          // Find chirp peak (high amplitude at start)
          let chirpStart = 0;
          for (let j = 0; j < samples.length; j++) {
            if (Math.abs(samples[j]) > 0.1) { // Adjust threshold based on testing
              chirpStart = j;
              break;
            }
          }

          // Find echo peak (next high amplitude after chirp)
          const minEchoSamples = Math.round(0.00889 * sampleRate); // 5ft ~8.89ms
          const maxEchoSamples = Math.round(0.3556 * sampleRate); // 200ft ~356ms
          let echoStart = chirpStart + minEchoSamples;
          for (let j = chirpStart + minEchoSamples; j < Math.min(samples.length, chirpStart + maxEchoSamples); j++) {
            if (Math.abs(samples[j]) > 0.05) { // Lower threshold for echo
              echoStart = j;
              break;
            }
          }

          // Calculate distance
          const delay = (echoStart - chirpStart) / sampleRate; // Seconds
          const distance = (delay * speedOfSound) / 2; // Round-trip
          if (distance >= 5 && distance <= 200) { // Validate range
            distances.push(distance.toFixed(2));
          } else {
            distances.push('N/A'); // Out of range or no echo detected
          }
        });

        // Display results
        document.getElementById('results').innerText = `Distances (ft): ${distances.join(', ')}`;
      }
    }

    // Error handling
    window.onerror = (msg) => {
      document.getElementById('results').innerText = `Error: ${msg}`;
    };
  </script>
</body>
</html>
